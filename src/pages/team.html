<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <meta name="description" content="Team – Team Apx Admin">
  <title>Team – Team Apx</title>
  <link rel="icon" type="image/png" href="../../assets/icons/APX.png">
  <link rel="stylesheet" href="../css/variables.css">
  <link rel="stylesheet" href="../css/style.css">
  <link rel="stylesheet" href="../css/auth.css">
  <link rel="stylesheet" href="../css/profile.css">
  <link rel="stylesheet" href="../css/team.css">
</head>
<body>

  <!-- Profile Navigation -->
  <nav class="navbar profile-header" id="navbar">
    <div class="nav-container">

      <!-- Logo -->
      <a href="../../index.html" class="nav-logo">
        <span class="logo-text">TEAM<strong>APX</strong></span>
      </a>

      <button class="lang-toggle" id="lang-toggle" style="margin-left: auto;">EN</button>

      <!-- User Menu (Burger) -->
      <div class="user-menu" id="user-menu">
        <button class="user-menu-toggle" id="user-menu-toggle" aria-label="Menu">
        <span class="hamburger-icon">
          <span></span>
          <span></span>
          <span></span>
        </span>
        </button>

        <div class="user-dropdown" id="user-dropdown">

          <!-- Guest -->
          <div class="user-dropdown-guest" id="dropdown-guest">
            <a href="login.html" class="user-dropdown-item" data-i18n="user.login">
              Login
            </a>
          </div>

          <!-- Auth -->
          <div class="user-dropdown-auth" id="dropdown-auth" style="display:none;">
            <span class="user-dropdown-name" id="dropdown-username"></span>

            <a href="profile.html"
               class="user-dropdown-item"
               data-i18n="user.profile">
              Profil
            </a>

            <a href="my-application.html"
               class="user-dropdown-item"
               id="dropdown-my-application"
               style="display:none;">
              Meine Bewerbung
            </a>

            <a href="settings.html"
               class="user-dropdown-item"
               data-i18n="user.settings">
              Einstellungen
            </a>

            <a href="applications.html"
               class="user-dropdown-item user-dropdown-admin"
               id="dropdown-applications"
               style="display:none;"
               data-i18n="user.applications">
              Bewerbungen
            </a>

            <a href="team.html"
               class="user-dropdown-item user-dropdown-admin"
               id="dropdown-team"
               style="display:none;"
               data-i18n="user.team">
              Team
            </a>

            <a href="#"
               class="user-dropdown-item"
               id="dropdown-logout"
               data-i18n="user.logout">
              Logout
            </a>
          </div>

        </div>
      </div>

    </div>
  </nav>

  <!-- Team Admin Content -->
  <div class="team-admin">
    <h1 class="section-title" data-i18n="team.title"><span class="accent">Team</span></h1>
    <p class="section-subtitle" data-i18n="team.subtitle">Team verwalten.</p>

    <!-- Loading -->
    <div class="team-loading" id="team-loading" data-i18n="team.loading">Lade Spieler...</div>

    <!-- Player Grid -->
    <div class="team-grid-admin" id="team-grid" style="display:none;"></div>

    <!-- Error -->
    <div class="team-error" id="team-error" style="display:none;">
      <p data-i18n="team.error">Zugriff verweigert. Bitte als Admin einloggen.</p>
      <a href="login.html" class="btn btn-primary" data-i18n="myapp.goToLogin">Zum Login</a>
    </div>
  </div>

  <!-- Edit Modal -->
  <div class="team-modal-overlay" id="team-modal">
    <div class="team-modal">
      <button class="team-modal-close" id="team-modal-close">&times;</button>
      <h2 class="team-modal-title" id="modal-player-name"></h2>

      <div class="team-form-field">
        <label for="modal-kills" data-i18n="team.label.kills">Kills</label>
        <input type="number" id="modal-kills" min="0" step="1">
      </div>

      <div class="team-form-field">
        <label for="modal-deaths" data-i18n="team.label.deaths">Deaths</label>
        <input type="number" id="modal-deaths" min="0" step="1">
      </div>

      <div class="team-form-field">
        <label for="modal-atk-role" data-i18n="team.label.atkRole">ATK Rolle</label>
        <select id="modal-atk-role">
          <option value="Entry-Frag">Entry-Frag</option>
          <option value="Second-Entry">Second-Entry</option>
          <option value="Breach">Breach</option>
          <option value="Support">Support</option>
          <option value="Intel">Intel</option>
          <option value="Anti-Gadget">Anti-Gadget</option>
          <option value="Flex">Flex</option>
        </select>
      </div>

      <div class="team-form-field">
        <label for="modal-def-role" data-i18n="team.label.defRole">DEF Rolle</label>
        <select id="modal-def-role">
          <option value="Anti-Entry">Anti-Entry</option>
          <option value="Anti-Gadget">Anti-Gadget</option>
          <option value="Intel">Intel</option>
          <option value="Flex">Flex</option>
          <option value="Support">Support</option>
          <option value="Crowd-Control">Crowd-Control</option>
          <option value="Trapper">Trapper</option>
        </select>
      </div>

      <!-- Live K/D Preview -->
      <div class="team-live-preview">
        <span class="team-live-label">K/D</span>
        <span class="team-live-value" id="modal-kd-preview">0.00</span>
      </div>

      <div class="team-live-preview">
        <span class="team-live-label">Rating</span>
        <span class="team-live-value" id="modal-rating-preview">1.00</span>
      </div>

      <button class="team-btn-save" id="modal-save" data-i18n="team.btn.save">Speichern</button>
      <div class="team-save-msg" id="modal-msg"></div>
    </div>
  </div>

  <!-- Footer -->
  <footer class="footer">
    <div class="container">
      <div class="footer-content">
        <div class="footer-brand">
          <span class="logo-text">TEAM<strong>APX</strong></span>
          <p data-i18n="footer.copy">&copy; 2026 Team Apx. Alle Rechte vorbehalten.</p>
        </div>
        <div class="footer-links">
          <a href="../../index.html" data-i18n="nav.home">Home</a>
          <a href="../../index.html#about" data-i18n="footer.about">Über uns</a>
          <a href="../../index.html#team" data-i18n="nav.team">Team</a>
        </div>
      </div>
    </div>
  </footer>

  <script src="../js/i18n.js"></script>
  <script src="../js/main.js"></script>
  <script src="../js/auth.js"></script>
  <script>
  (function () {
    var gridEl = document.getElementById('team-grid');
    var loadingEl = document.getElementById('team-loading');
    var errorEl = document.getElementById('team-error');
    var modal = document.getElementById('team-modal');
    var closeBtn = document.getElementById('team-modal-close');
    var saveBtn = document.getElementById('modal-save');
    var msgEl = document.getElementById('modal-msg');
    var killsInput = document.getElementById('modal-kills');
    var deathsInput = document.getElementById('modal-deaths');
    var atkRoleSelect = document.getElementById('modal-atk-role');
    var defRoleSelect = document.getElementById('modal-def-role');
    var kdPreview = document.getElementById('modal-kd-preview');
    var ratingPreview = document.getElementById('modal-rating-preview');
    var nameEl = document.getElementById('modal-player-name');

    var currentPlayer = null;
    var players = [];

    // Rating weights from rating-weights.json (averaged for simplified calc)
    var AVG_KILL_WEIGHT = 1.025;   // avg(1.2, 0.8, 1.5, 0.6)
    var AVG_DEATH_WEIGHT = -0.767; // avg(-1.3, -0.4, -0.6)

    function calcKD(kills, deaths) {
      if (deaths === 0) return kills > 0 ? kills.toFixed(2) : '0.00';
      return (kills / deaths).toFixed(2);
    }

    function calcRating(kills, deaths) {
      // Simplified from info.txt formula:
      // raw_score = kills * avg_kill_weight + deaths * avg_death_weight
      // rating = (raw_score / total_rounds) + 1.0
      // We approximate total_rounds as (kills + deaths) / 2 (minimum 1)
      var rounds = Math.max((kills + deaths) / 2, 1);
      var rawScore = (kills * AVG_KILL_WEIGHT) + (deaths * AVG_DEATH_WEIGHT);
      return ((rawScore / rounds) + 1.0).toFixed(2);
    }

    function kdClass(kd) {
      var v = parseFloat(kd);
      if (v > 1.20) return 'kd-good';
      if (v < 0.90) return 'kd-bad';
      return 'kd-avg';
    }

    function ratingClass(rating) {
      var v = parseFloat(rating);
      if (v > 1.20) return 'kd-good';
      if (v < 0.90) return 'kd-bad';
      return 'kd-avg';
    }

    // Load team members
    function loadTeam() {
      fetch('/api/admin/team', { credentials: 'same-origin' })
        .then(function (r) {
          if (r.status === 401 || r.status === 403) throw new Error('unauthorized');
          return r.json();
        })
        .then(function (data) {
          players = data.members || [];
          loadingEl.style.display = 'none';
          gridEl.style.display = 'grid';
          renderGrid();
        })
        .catch(function () {
          loadingEl.style.display = 'none';
          errorEl.style.display = 'block';
        });
    }

    function renderGrid() {
      gridEl.innerHTML = '';
      players.forEach(function (p) {
        var kd = calcKD(p.kills, p.deaths);
        var rating = calcRating(p.kills, p.deaths);

        var card = document.createElement('div');
        card.className = 'team-player-card';
        var roleText = '';
        if (p.atk_role && p.def_role) roleText = p.atk_role + ' | ' + p.def_role;
        else if (p.atk_role) roleText = p.atk_role;
        else if (p.def_role) roleText = p.def_role;

        card.innerHTML =
          '<div class="team-player-header">' +
            '<span class="team-player-name">' + escapeHtml(p.name) + '</span>' +
            (roleText ? '<span class="team-player-role">' + escapeHtml(roleText) + '</span>' : '') +
          '</div>' +
          '<div class="team-player-stats">' +
            '<div class="team-stat">' +
              '<span class="team-stat-value">' + p.kills + '</span>' +
              '<span class="team-stat-label">Kills</span>' +
            '</div>' +
            '<div class="team-stat">' +
              '<span class="team-stat-value">' + p.deaths + '</span>' +
              '<span class="team-stat-label">Deaths</span>' +
            '</div>' +
            '<div class="team-stat">' +
              '<span class="team-stat-value team-kd-badge ' + kdClass(kd) + '">' + kd + '</span>' +
              '<span class="team-stat-label">K/D</span>' +
            '</div>' +
            '<div class="team-stat">' +
              '<span class="team-stat-value team-kd-badge ' + ratingClass(rating) + '">' + rating + '</span>' +
              '<span class="team-stat-label">Rating</span>' +
            '</div>' +
          '</div>';

        card.addEventListener('click', function () { openModal(p); });
        gridEl.appendChild(card);
      });
    }

    function escapeHtml(str) {
      if (!str) return '';
      var div = document.createElement('div');
      div.textContent = str;
      return div.innerHTML;
    }

    // Modal
    function openModal(player) {
      currentPlayer = player;
      nameEl.textContent = player.name;
      killsInput.value = player.kills;
      deathsInput.value = player.deaths;
      atkRoleSelect.value = player.atk_role || 'Entry-Frag';
      defRoleSelect.value = player.def_role || 'Anti-Entry';
      updatePreview();
      msgEl.style.display = 'none';
      msgEl.className = 'team-save-msg';
      modal.classList.add('active');
    }

    function closeModal() {
      modal.classList.remove('active');
      currentPlayer = null;
    }

    closeBtn.addEventListener('click', closeModal);
    modal.addEventListener('click', function (e) {
      if (e.target === modal) closeModal();
    });
    document.addEventListener('keydown', function (e) {
      if (e.key === 'Escape') closeModal();
    });

    // Live preview
    function updatePreview() {
      var k = parseInt(killsInput.value) || 0;
      var d = parseInt(deathsInput.value) || 0;
      if (k < 0) k = 0;
      if (d < 0) d = 0;

      var kd = calcKD(k, d);
      var rating = calcRating(k, d);

      kdPreview.textContent = kd;
      kdPreview.className = 'team-live-value team-kd-badge ' + kdClass(kd);

      ratingPreview.textContent = rating;
      ratingPreview.className = 'team-live-value team-kd-badge ' + ratingClass(rating);
    }

    killsInput.addEventListener('input', updatePreview);
    deathsInput.addEventListener('input', updatePreview);

    // Save
    saveBtn.addEventListener('click', function () {
      if (!currentPlayer) return;

      var kills = parseInt(killsInput.value) || 0;
      var deaths = parseInt(deathsInput.value) || 0;
      var atkRole = atkRoleSelect.value;
      var defRole = defRoleSelect.value;

      if (kills < 0) kills = 0;
      if (deaths < 0) deaths = 0;

      saveBtn.disabled = true;
      msgEl.style.display = 'none';
      msgEl.className = 'team-save-msg';

      fetch('/api/admin/team', {
        method: 'PUT',
        headers: { 'Content-Type': 'application/json' },
        credentials: 'same-origin',
        body: JSON.stringify({
          id: currentPlayer.id,
          name: currentPlayer.name,
          kills: kills,
          deaths: deaths,
          atk_role: atkRole,
          def_role: defRole
        })
      })
        .then(function (r) {
          if (!r.ok) throw new Error('save failed');
          return r.json();
        })
        .then(function () {
          // Update local data
          currentPlayer.kills = kills;
          currentPlayer.deaths = deaths;
          currentPlayer.atk_role = atkRole;
          currentPlayer.def_role = defRole;
          renderGrid();

          msgEl.textContent = getLang() === 'de' ? 'Gespeichert.' : 'Saved.';
          msgEl.className = 'team-save-msg success';
          saveBtn.disabled = false;

          setTimeout(function () {
            msgEl.style.display = 'none';
            msgEl.className = 'team-save-msg';
          }, 2000);
        })
        .catch(function () {
          msgEl.textContent = getLang() === 'de' ? 'Speichern fehlgeschlagen.' : 'Save failed.';
          msgEl.className = 'team-save-msg error';
          saveBtn.disabled = false;
        });
    });

    function getLang() {
      return localStorage.getItem('lang') || 'en';
    }

    // Init
    loadTeam();
  })();
  </script>
</body>
</html>
